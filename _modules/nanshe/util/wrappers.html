

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>nanshe.util.wrappers &mdash; nanshe 0.1.0a46+10.g035f987 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.0a46+10.g035f987',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../../_static/cloud.js"></script>
    <link rel="top" title="nanshe 0.1.0a46+10.g035f987 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">nanshe 0.1.0a46+10.g035f987 documentation</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for nanshe.util.wrappers</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The module ``wrappers`` provides support decorating functions and classes.</span>

<span class="sd">===============================================================================</span>
<span class="sd">Overview</span>
<span class="sd">===============================================================================</span>
<span class="sd">The module ``wrappers`` extends wrapping abilities found in |functools|_. In</span>
<span class="sd">particular, it is ensured all wrapped functions contain an attribute</span>
<span class="sd">``__wrapped__``, which points back to the original function before the wrapper</span>
<span class="sd">was applied. Also, the ability to wrap classes with a decorator to apply a</span>
<span class="sd">``metaclass`` or series of ``metaclass``es is provided. Making it much easier</span>
<span class="sd">to transform classes without mucking in their internals. For classes inheriting</span>
<span class="sd">from ``Qt`` objects a special decorator is provided to make sure they</span>
<span class="sd">participate in the correct inheritance scheme.</span>

<span class="sd">.. |functools| replace:: ``functools``</span>
<span class="sd">.. _functools: http://docs.python.org/2/library/functools.html</span>

<span class="sd">===============================================================================</span>
<span class="sd">API</span>
<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;John Kirkham &lt;kirkhamj@janelia.hhmi.org&gt;&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;$Jul 23, 2014 16:24:36 EDT$&quot;</span>


<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">import</span> <span class="nn">PyQt4.QtCore</span>


<div class="viewcode-block" id="update_wrapper"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.update_wrapper">[docs]</a><span class="k">def</span> <span class="nf">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span>
                   <span class="n">wrapped</span><span class="p">,</span>
                   <span class="n">assigned</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">WRAPPER_ASSIGNMENTS</span><span class="p">,</span>
                   <span class="n">updated</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">WRAPPER_UPDATES</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extends functools.update_wrapper to ensure that it stores the wrapped</span>
<span class="sd">        function in the attribute __wrapped__.</span>

<span class="sd">        Args:</span>
<span class="sd">            wrapper(callable):      the replacement callable.</span>

<span class="sd">            wrapped(callable):      the callable that is being wrapped.</span>

<span class="sd">            assigned(tuple):        is a tuple naming the attributes assigned</span>
<span class="sd">                                    directly from the wrapped function to the</span>
<span class="sd">                                    wrapper function (defaults to</span>
<span class="sd">                                    functools.WRAPPER_ASSIGNMENTS)</span>

<span class="sd">            updated(tuple):         is a tuple naming the attributes of the</span>
<span class="sd">                                    wrapper that are updated with the</span>
<span class="sd">                                    corresponding attribute from the wrapped</span>
<span class="sd">                                    function (defaults to</span>
<span class="sd">                                    functools.WRAPPER_UPDATES)</span>

<span class="sd">        Returns:</span>
<span class="sd">            (callable):             the wrapped callable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">wrapper</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span>
        <span class="n">wrapper</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">,</span> <span class="n">assigned</span><span class="o">=</span><span class="n">assigned</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="n">updated</span>
    <span class="p">)</span>

    <span class="c1"># Store the underlying callable. Automatic in Python 3.</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span></div>


<div class="viewcode-block" id="wraps"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.wraps">[docs]</a><span class="k">def</span> <span class="nf">wraps</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span>
          <span class="n">assigned</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">WRAPPER_ASSIGNMENTS</span><span class="p">,</span>
          <span class="n">updated</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">WRAPPER_UPDATES</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds on functools.wraps to ensure that it stores the wrapped function</span>
<span class="sd">        in the attribute __wrapped__.</span>

<span class="sd">        Args:</span>
<span class="sd">            wrapped(callable):      the callable that is being wrapped.</span>

<span class="sd">            assigned(tuple):        is a tuple naming the attributes assigned</span>
<span class="sd">                                    directly from the wrapped function to the</span>
<span class="sd">                                    wrapper function (defaults to</span>
<span class="sd">                                    functools.WRAPPER_ASSIGNMENTS)</span>

<span class="sd">            updated(tuple):         is a tuple naming the attributes of the</span>
<span class="sd">                                    wrapper that are updated with the</span>
<span class="sd">                                    corresponding attribute from the wrapped</span>
<span class="sd">                                    function (defaults to</span>
<span class="sd">                                    functools.WRAPPER_UPDATES)</span>

<span class="sd">        Returns:</span>
<span class="sd">            (callable):             a decorator for callable, which will</span>
<span class="sd">                                    contain wrapped.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">update_wrapper</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">=</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">assigned</span><span class="o">=</span><span class="n">assigned</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="n">updated</span>
    <span class="p">))</span></div>


<div class="viewcode-block" id="identity_wrapper"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.identity_wrapper">[docs]</a><span class="k">def</span> <span class="nf">identity_wrapper</span><span class="p">(</span><span class="n">a_callable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trivially wraps a given callable without doing anything else to it.</span>

<span class="sd">        Args:</span>
<span class="sd">            a_callable(callable):   the callable that is being wrapped.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (callable):             a wrapped callable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">a_callable</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped_callable</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Trivially wraps a given callable without doing anything else to it.</span>

<span class="sd">            Args:</span>
<span class="sd">                *args:      Variable length argument list.</span>
<span class="sd">                **kwargs:   Arbitrary keyword arguments.</span>

<span class="sd">            Returns:</span>
<span class="sd">                Same as what `a_callable` returns.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span><span class="p">(</span><span class="n">a_callable</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">wrapped_callable</span><span class="p">)</span></div>


<div class="viewcode-block" id="static_variables"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.static_variables">[docs]</a><span class="k">def</span> <span class="nf">static_variables</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a decorator that decorates a callable such that it has the</span>
<span class="sd">        given static variables set.</span>

<span class="sd">        Args:</span>
<span class="sd">            *kwargs(tuple):     keyword args will be set to the value provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (decorator):        a decorator for the callable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">static_variables_tie</span><span class="p">(</span><span class="n">a_callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Decorates a function such that it has the given static variables</span>
<span class="sd">            set.</span>

<span class="sd">            Args:</span>
<span class="sd">                a_callable(callable):     the callable to decorate.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (callable):               the callable returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">callable_wrapped</span> <span class="o">=</span> <span class="n">identity_wrapper</span><span class="p">(</span><span class="n">a_callable</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">each_kwd</span><span class="p">,</span> <span class="n">each_val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">callable_wrapped</span><span class="p">,</span> <span class="n">each_kwd</span><span class="p">,</span> <span class="n">each_val</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">callable_wrapped</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">static_variables_tie</span><span class="p">)</span></div>


<div class="viewcode-block" id="metaclass"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.metaclass">[docs]</a><span class="k">def</span> <span class="nf">metaclass</span><span class="p">(</span><span class="n">meta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a decorator that decorates a class such that the given</span>
<span class="sd">        metaclass is applied.</span>

<span class="sd">        Note:</span>
<span class="sd">            Decorator will add the __metaclass__ attribute so the last</span>
<span class="sd">            metaclass applied is known. Also, decorator will add the</span>
<span class="sd">            __wrapped__ attribute so that the unwrapped class can be retrieved.</span>

<span class="sd">        Args:</span>
<span class="sd">            meta(metaclass):     metaclass to apply to a given class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (decorator):         a decorator for the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">metaclass_wrapper</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a decorated class such that the given metaclass is applied.</span>

<span class="sd">            Note:</span>
<span class="sd">                Adds the __metaclass__ attribute so the last metaclass used is</span>
<span class="sd">                known. Also, adds the __wrapped__ attribute so that the</span>
<span class="sd">                unwrapped class can be retrieved.</span>

<span class="sd">            Args:</span>
<span class="sd">                cls(class):          class to decorate.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (class):             the decorated class.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">__name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">__bases</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__bases__</span><span class="p">)</span>
        <span class="n">__dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>

        <span class="n">__dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">__dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__weakref__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">each_slot</span> <span class="ow">in</span> <span class="n">__dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__slots__&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">()):</span>
            <span class="n">__dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">each_slot</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">__dict</span><span class="p">[</span><span class="s2">&quot;__metaclass__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="n">__dict</span><span class="p">[</span><span class="s2">&quot;__wrapped__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>

        <span class="k">return</span><span class="p">(</span><span class="n">meta</span><span class="p">(</span><span class="n">__name</span><span class="p">,</span> <span class="n">__bases</span><span class="p">,</span> <span class="n">__dict</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metaclass_wrapper</span><span class="p">)</span></div>


<div class="viewcode-block" id="metaclasses"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.metaclasses">[docs]</a><span class="k">def</span> <span class="nf">metaclasses</span><span class="p">(</span><span class="o">*</span><span class="n">metas</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a decorator that decorates a class such that the given</span>
<span class="sd">        metaclasses are applied.</span>

<span class="sd">        Note:</span>
<span class="sd">            Shorthand for repeated application of metaclass.</span>

<span class="sd">        Args:</span>
<span class="sd">            *metas(metaclasses):     metaclasses to apply to a given class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (decorator):             a decorator for the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">metaclasses_wrapper</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a decorated class such that the given metaclasses are</span>
<span class="sd">            applied.</span>

<span class="sd">            Args:</span>
<span class="sd">                cls(class):          class to decorate.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (class):             the decorated class.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_cls</span> <span class="o">=</span> <span class="n">cls</span>

        <span class="k">for</span> <span class="n">each_meta</span> <span class="ow">in</span> <span class="n">metas</span><span class="p">:</span>
            <span class="n">new_cls</span> <span class="o">=</span> <span class="n">metaclass</span><span class="p">(</span><span class="n">each_meta</span><span class="p">)(</span><span class="n">new_cls</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">new_cls</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metaclasses_wrapper</span><span class="p">)</span></div>


<div class="viewcode-block" id="class_static_variables"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.class_static_variables">[docs]</a><span class="k">def</span> <span class="nf">class_static_variables</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a decorator that decorates a class such that it has the given</span>
<span class="sd">        static variables set.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs(tuple):     keyword args will be set to the value</span>
<span class="sd">                                 provided.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (decorator):         a decorator for the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">MetaStaticVariables</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Metaclass, which adds static variable with the given value to a</span>
<span class="sd">            class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
            <span class="n">dct</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">return</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">MetaStaticVariables</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span>
                <span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span>
            <span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metaclass</span><span class="p">(</span><span class="n">MetaStaticVariables</span><span class="p">))</span></div>


<div class="viewcode-block" id="class_decorate_all_methods"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.class_decorate_all_methods">[docs]</a><span class="k">def</span> <span class="nf">class_decorate_all_methods</span><span class="p">(</span><span class="o">*</span><span class="n">decorators</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a decorator that decorates a class such that all its methods</span>
<span class="sd">        are decorated by the decorators provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            *decorators(tuple):     decorators to decorate all methods with.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (decorator):            a decorator for the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">MetaAllMethodsDecorator</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Metaclass, which decorates all methods with the list of decorators</span>
<span class="sd">            in order.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Are all of FunctionType at this point.</span>
                <span class="c1"># Will be of MethodType at a later step.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_v</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">each_decorator</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
                        <span class="n">_v</span> <span class="o">=</span> <span class="n">each_decorator</span><span class="p">(</span><span class="n">_v</span><span class="p">)</span>

                <span class="n">dct</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_v</span>

            <span class="k">return</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">MetaAllMethodsDecorator</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span>
                <span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span>
            <span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metaclass</span><span class="p">(</span><span class="n">MetaAllMethodsDecorator</span><span class="p">))</span></div>


<div class="viewcode-block" id="qt_class_decorate_all_methods"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.qt_class_decorate_all_methods">[docs]</a><span class="k">def</span> <span class="nf">qt_class_decorate_all_methods</span><span class="p">(</span><span class="o">*</span><span class="n">decorators</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a decorator that decorates a class such that all its methods</span>
<span class="sd">        are decorated by the decorators provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            *decorators(tuple):     decorators to decorate all methods with.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (decorator):            a decorator for the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">MetaAllMethodsDecorator</span><span class="p">(</span><span class="n">PyQt4</span><span class="o">.</span><span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtWrapperType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Metaclass, which decorates all methods with the list of decorators</span>
<span class="sd">            in order.</span>

<span class="sd">            Inherits from PyQt4.QtCore.pyqtWrapperType based on this</span>
<span class="sd">            ( http://www.gulon.co.uk/2012/12/28/pyqt4-qobjects-and-metaclasses/ ).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Are all of FunctionType at this point.</span>
                <span class="c1"># Will be of MethodType at a later step.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_v</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">each_decorator</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
                        <span class="n">_v</span> <span class="o">=</span> <span class="n">each_decorator</span><span class="p">(</span><span class="n">_v</span><span class="p">)</span>

                <span class="n">dct</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_v</span>

            <span class="k">return</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">MetaAllMethodsDecorator</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span>
                <span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span>
            <span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metaclass</span><span class="p">(</span><span class="n">MetaAllMethodsDecorator</span><span class="p">))</span></div>


<div class="viewcode-block" id="class_decorate_methods"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.class_decorate_methods">[docs]</a><span class="k">def</span> <span class="nf">class_decorate_methods</span><span class="p">(</span><span class="o">**</span><span class="n">method_decorators</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a decorator that decorates a class such that specified methods</span>
<span class="sd">        are decorated by the decorators provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            **method_decorators(tuple):     method names with a single</span>
<span class="sd">                                            decorator or a list of decorators.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (decorator):                    a decorator for the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">MetaMethodsDecorator</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Metaclass, which decorates some methods based on the keys given.</span>
<span class="sd">            Uses the decorator(s) provided for each method to decorator in</span>
<span class="sd">            order.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_v</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                    <span class="n">_dl</span> <span class="o">=</span> <span class="n">method_decorators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_dl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="nb">iter</span><span class="p">(</span><span class="n">_dl</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="n">_dl</span> <span class="o">=</span> <span class="p">[</span><span class="n">_dl</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">_d</span> <span class="ow">in</span> <span class="n">_dl</span><span class="p">:</span>
                            <span class="n">_v</span> <span class="o">=</span> <span class="n">_d</span><span class="p">(</span><span class="n">_v</span><span class="p">)</span>

                <span class="n">dct</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_v</span>

            <span class="k">return</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">MetaMethodsDecorator</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span>
                <span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span>
            <span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metaclass</span><span class="p">(</span><span class="n">MetaMethodsDecorator</span><span class="p">))</span></div>


<div class="viewcode-block" id="unwrap"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.unwrap">[docs]</a><span class="k">def</span> <span class="nf">unwrap</span><span class="p">(</span><span class="n">a_callable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the underlying function that was wrapped.</span>

<span class="sd">        Args:</span>
<span class="sd">            a_callable(callable):     some wrapped (or not) callable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (callable):               the callable that is no longer wrapped.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unwrapped_callable</span> <span class="o">=</span> <span class="n">a_callable</span>

    <span class="k">while</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">unwrapped_callable</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">):</span>
        <span class="n">unwrapped_callable</span> <span class="o">=</span> <span class="n">unwrapped_callable</span><span class="o">.</span><span class="n">__wrapped__</span>

    <span class="k">return</span><span class="p">(</span><span class="n">unwrapped_callable</span><span class="p">)</span></div>


<div class="viewcode-block" id="tied_call_args"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.tied_call_args">[docs]</a><span class="k">def</span> <span class="nf">tied_call_args</span><span class="p">(</span><span class="n">a_callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ties all the args to their respective variable names.</span>

<span class="sd">        Args:</span>
<span class="sd">            a_callable(callable):     some callable.</span>
<span class="sd">            *args(callable):          positional arguments for the callable.</span>
<span class="sd">            **kwargs(callable):       keyword arguments for the callable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            args (tuple):             ordered dictionary of arguments name and</span>
<span class="sd">                                      their values, all variadic position</span>
<span class="sd">                                      arguments, all variadic keyword</span>
<span class="sd">                                      arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">a_callable</span><span class="p">)</span>

    <span class="n">unsorted_callargs</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getcallargs</span><span class="p">(</span><span class="n">a_callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">new_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">varargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="n">unsorted_callargs</span><span class="p">[</span><span class="n">sig</span><span class="o">.</span><span class="n">varargs</span><span class="p">]</span>

    <span class="n">new_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">keywords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">new_kwargs</span> <span class="o">=</span> <span class="n">unsorted_callargs</span><span class="p">[</span><span class="n">sig</span><span class="o">.</span><span class="n">keywords</span><span class="p">]</span>

    <span class="n">callargs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">each_arg</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">callargs</span><span class="p">[</span><span class="n">each_arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">unsorted_callargs</span><span class="p">[</span><span class="n">each_arg</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">callargs</span><span class="p">,</span> <span class="n">new_args</span><span class="p">,</span> <span class="n">new_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="repack_call_args"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.repack_call_args">[docs]</a><span class="k">def</span> <span class="nf">repack_call_args</span><span class="p">(</span><span class="n">a_callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reorganizes args and kwargs to match the given callables signature.</span>

<span class="sd">        Args:</span>
<span class="sd">            a_callable(callable):     some callable.</span>
<span class="sd">            *args(callable):          positional arguments for the callable.</span>
<span class="sd">            **kwargs(callable):       keyword arguments for the callable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            args (tuple):             all arguments as passed as position</span>
<span class="sd">                                      arguments, all default arguments and</span>
<span class="sd">                                      all arguments passed as keyword</span>
<span class="sd">                                      arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">callargs</span><span class="p">,</span> <span class="n">new_args</span><span class="p">,</span> <span class="n">new_kwargs</span> <span class="o">=</span> <span class="n">tied_call_args</span><span class="p">(</span>
        <span class="n">a_callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="n">new_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">callargs</span><span class="o">.</span><span class="n">values</span><span class="p">()[:</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)])</span> <span class="o">+</span> <span class="n">new_args</span>
    <span class="n">new_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">callargs</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):]))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">new_args</span><span class="p">,</span> <span class="n">new_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="with_setup_state"><a class="viewcode-back" href="../../../nanshe.util.wrappers.html#nanshe.util.wrappers.with_setup_state">[docs]</a><span class="k">def</span> <span class="nf">with_setup_state</span><span class="p">(</span><span class="n">setup</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">teardown</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds setup and teardown callable to a function s.t. they can mutate it.</span>

<span class="sd">        Based on ``with_setup`` from ``nose``. This goes a bit further than</span>
<span class="sd">        ``nose`` does and provides a mechanism for the setup and teardown</span>
<span class="sd">        functions to change the callable in question. In other words, variables</span>
<span class="sd">        generated in setup can be stored in the functions globals and then</span>
<span class="sd">        cleaned up and removed in teardown. The final result of using this</span>
<span class="sd">        function should be a function equivalent to one generated by</span>
<span class="sd">        ``with_setup``.</span>

<span class="sd">        Args:</span>
<span class="sd">            setup(callable):        A callable that takes the decorated</span>
<span class="sd">                                    function as an argument. This sets up the</span>
<span class="sd">                                    function before execution.</span>

<span class="sd">            teardown(callable):     A callable that takes the decorated</span>
<span class="sd">                                    function as an argument. This cleans up the</span>
<span class="sd">                                    function after execution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            callable:               Does the actual decoration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">with_setup_state_wrapper</span><span class="p">(</span><span class="n">a_callable</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="n">setup</span><span class="p">,</span> <span class="n">teardown</span><span class="o">=</span><span class="n">teardown</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Mutates the callable s.t. it has globals for setup and teardown.</span>

<span class="sd">            Args:</span>
<span class="sd">                setup(callable):        A callable that takes the decorated</span>
<span class="sd">                                        function as an argument. This sets up</span>
<span class="sd">                                        the function before execution. Simply</span>
<span class="sd">                                        forwarded from before.</span>

<span class="sd">                teardown(callable):     A callable that takes the decorated</span>
<span class="sd">                                        function as an argument. This cleans up</span>
<span class="sd">                                        the function after execution. Simply</span>
<span class="sd">                                        forwarded from before.</span>

<span class="sd">            Returns:</span>
<span class="sd">                callable:               The original callable with setup and</span>
<span class="sd">                                        teardown globals.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stage_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="n">setup</span><span class="p">,</span> <span class="s2">&quot;teardown&quot;</span><span class="p">:</span> <span class="n">teardown</span><span class="p">}</span>
        <span class="n">stage_orderer</span> <span class="o">=</span> <span class="p">[(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span>
        <span class="n">stage_itr</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">stage_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">stage_orderer</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">each_stage_name</span><span class="p">,</span> <span class="n">each_new_stage</span><span class="p">),</span> <span class="n">each_stage_orderer</span> <span class="ow">in</span> <span class="n">stage_itr</span><span class="p">:</span>
            <span class="n">each_old_stage</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a_callable</span><span class="p">,</span> <span class="n">each_stage_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">each_new_stage</span><span class="p">:</span>
                <span class="n">each_new_stage</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">each_new_stage</span><span class="p">,</span> <span class="n">a_callable</span><span class="p">)</span>

            <span class="n">chained_stages</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">each_old_stage</span> <span class="ow">and</span> <span class="n">each_new_stage</span><span class="p">:</span>
                <span class="n">first_stage</span><span class="p">,</span> <span class="n">second_stage</span> <span class="o">=</span> <span class="n">each_stage_orderer</span><span class="p">(</span>
                    <span class="n">each_old_stage</span><span class="p">,</span> <span class="n">each_new_stage</span>
                <span class="p">)</span>

                <span class="k">def</span> <span class="nf">stages</span><span class="p">(</span><span class="n">first_stage</span><span class="o">=</span><span class="n">first_stage</span><span class="p">,</span>
                           <span class="n">second_stage</span><span class="o">=</span><span class="n">second_stage</span><span class="p">):</span>
                    <span class="n">first_stage</span><span class="p">()</span>
                    <span class="n">second_stage</span><span class="p">()</span>

                <span class="n">chained_stages</span> <span class="o">=</span> <span class="n">stages</span>
            <span class="k">elif</span> <span class="n">each_old_stage</span><span class="p">:</span>
                <span class="n">chained_stages</span> <span class="o">=</span> <span class="n">each_old_stage</span>
            <span class="k">elif</span> <span class="n">each_new_stage</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">a_stage</span><span class="p">(</span><span class="n">each_new_stage</span><span class="o">=</span><span class="n">each_new_stage</span><span class="p">):</span>
                    <span class="n">each_new_stage</span><span class="p">()</span>

                <span class="n">chained_stages</span> <span class="o">=</span> <span class="n">a_stage</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="n">a_callable</span><span class="p">,</span> <span class="n">each_stage_name</span><span class="p">,</span> <span class="n">chained_stages</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">a_callable</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">with_setup_state_wrapper</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">nanshe 0.1.0a46+10.g035f987 documentation</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2014-2015, John A. Kirkham.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>